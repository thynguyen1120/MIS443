-- Final Exam MIS 443 Q4 - 2024-2025 - Skeleton
-- Your ID: 2232300307
-- Your Name: Nguyen Tran Ngoc Thy
/*
Question 1 (10 marks): Create a database named “yourfullname” (e.g: dangthaidoan”) use PGAdmin, then create a schema name “cd” that has three tables: members, bookings and facilities 
using SQL statements. Ensure each table includes appropriate primary and foreign keys, and data types. 
Submit the SQL script as part of your answer.
*/

-- Q1.A Check tables
SELECT table_name, column_name, data_type
FROM information_schema.columns
WHERE table_schema = 'ba' 
ORDER BY table_name, ordinal_position;

-- Q1. B. check table student
-- Your answer here
CREATE TABLE ba.students (
  studenid serial PRIMARY KEY,
  fullname character varying(200),
  email character varying(100));

INSERT INTO ba.students (studentid, fullname, email)
VALUES ('2232300307', 'Nguyen Tran Ngoc Thy', 'thy.nguyentran.bbs22@eiu.edu.vn');

select column_name, data_type
from information_schema.columns
where table_schema = 'ba' and table_name = 'students'
order by ordinal_position;

select * from ba.students order by created_at desc;

-- End your answer

/*
Question 2 (10 marks): Write an SQL query to find the top 3 facilities that have been booked the most number of total slots (not just number of bookings).
Display their facility ID and the total number of slots booked, sorted from highest to lowest.
*/
-- Your answer here
select b.facid, sum(b.slots) as total_slots
from ba.bookings as b
group by b.facid
order by total_slots desc
limit 3;

-- End your answer
/*
Question 3 (20 marks): Write an SQL query to display all bookings that lasted more than 2 slots, along with the member ID, facility ID, and facility name, 
sorted by member ID and then by start time (ascending).
*/
-- Your answer here
select b.memid, b.facid, f.name as facility_name, b.starttime, b.slots
from ba.bookings as b
join ba.facilities as f on f.facid = b.facid
where b.slots > 2
order by b.memid, b.starttime;


-- End your answer
/*
Question 4 (20 marks):  Write an SQL query to display each member and the number of bookings they made for facility ID = 1. 
Include all members, even those who have never booked that facility.
*/
-- Your answer here
select m.memid, m.firstname ||' '|| m.surname as member_name,
coalesce(count(b.bookid), 0) as facility1_bookings
from ba.members as m
left join ba.bookings as b on b.memid = m.memid
and b.facid = 1
group by m.memid
order by facility1_bookings desc; 

-- End your answer
/*
Question 5 (20 marks):   Write an SQL query to show the total number of slots booked by guests (memid = 0) for each facility.
Include the facility name and display the result in descending order of total slots used.
*/
-- Your answer here
select f.facid, f.name as facility_name,
coalesce(sum(case when b.memid=0 then b.slots end), 0) as total_guest_slots
from ba.facilities f
left join ba.bookings as b on b.facid = f.facid
group by f.facid, f.name
order by total_guest_slots desc, f.facid;

-- End your answer
/*
Question 6 (20 marks): Write an SQL query to rank members based on their total number of bookings. 
Members with the same number of bookings should have the same rank. Only include members who have made at least one booking
*/
-- Your answer here
with cnt as (
  select b.memid,
         count(*) as total_bookings
  from ba.bookings as b 
  group by b.memid
)
select m.memid, m.firstname || ' ' || m.surname as member_name, c.total_bookings,
      rank() over (order by c.total_bookings desc) as rank
from cnt as c
join ba.members as m on m.memid = c.memid
order by rank, m.memid;






-- End your answer
